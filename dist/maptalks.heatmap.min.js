/*!
 * maptalks.heatmap v0.6.0
 * LICENSE : MIT
 * (c) 2016-2019 maptalks.org
 */
/*!
 * requires maptalks@^0.25.0 
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,C){"use strict";var e,s=(function(t){function e(t){if(!(this instanceof e))return new e(t);this._canvas=t="string"==typeof t?document.getElementById(t):t,this._ctx=t.getContext("2d"),this._width=t.width,this._height=t.height,this._max=1,this._data=[]}(t.exports=e).prototype={defaultRadius:25,defaultGradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow",1:"red"},data:function(t){return this._data=t,this},max:function(t){return this._max=t,this},add:function(t){return this._data.push(t),this},clear:function(){return this._data=[],this},radius:function(t,e){e=void 0===e?15:e;var i=this._circle=this._createCanvas(),a=i.getContext("2d"),r=this._r=t+e;return i.width=i.height=2*r,a.shadowOffsetX=a.shadowOffsetY=2*r,a.shadowBlur=e,a.shadowColor="black",a.beginPath(),a.arc(-r,-r,t,0,2*Math.PI,!0),a.closePath(),a.fill(),this},resize:function(){this._width=this._canvas.width,this._height=this._canvas.height},gradient:function(t){var e=this._createCanvas(),i=e.getContext("2d"),a=i.createLinearGradient(0,0,0,256);for(var r in e.width=1,e.height=256,t)a.addColorStop(+r,t[r]);return i.fillStyle=a,i.fillRect(0,0,1,256),this._grad=i.getImageData(0,0,1,256).data,this},draw:function(t){this._circle||this.radius(this.defaultRadius),this._grad||this.gradient(this.defaultGradient);var e=this._ctx;e.clearRect(0,0,this._width,this._height);for(var i,a=0,r=this._data.length;a<r;a++)i=this._data[a],e.globalAlpha=Math.max(i[2]/this._max,void 0===t?.05:t),e.drawImage(this._circle,i[0]-this._r,i[1]-this._r);var n=e.getImageData(0,0,this._width,this._height);return this._colorize(n.data,this._grad),e.putImageData(n,0,0),this},_colorize:function(t,e){for(var i,a=0,r=t.length;a<r;a+=4)(i=4*t[a+3])&&(t[a]=e[i],t[a+1]=e[1+i],t[a+2]=e[2+i])},_createCanvas:function(){return"undefined"!=typeof document?document.createElement("canvas"):new this._canvas.constructor}}}(e={exports:{}},e.exports),e.exports);function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):function(t,e){for(var i=Object.getOwnPropertyNames(e),a=0;a<i.length;a++){var r=i[a],n=Object.getOwnPropertyDescriptor(e,r);n&&n.configurable&&void 0===t[r]&&Object.defineProperty(t,r,n)}}(t,e))}var o,a,h={max:1,gradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow",1:"red"},radius:25,blur:15,heatValueScale:1,minOpacity:.05},c=(i(d,o=C.Layer),d.prototype.getData=function(){return this._heats},d.prototype.setData=function(t){return this._heats=t||[],this.redraw()},d.prototype.addPoint=function(t){return t?(t[0]&&Array.isArray(t[0])?C.Util.pushIn(this._heats,t):this._heats.push(t),this.redraw()):this},d.prototype.onConfig=function(t){for(var e in t)if(h[e])return this.redraw();return this},d.prototype.redraw=function(){var t=this._getRenderer();return t&&(t.clearHeatCache(),t.setToRedraw()),this},d.prototype.isEmpty=function(){return!this._heats.length},d.prototype.clear=function(){return this._heats=[],this.redraw(),this.fire("clear"),this},d.prototype.toJSON=function(t){t||(t={});var e={type:this.getJSONType(),id:this.getId(),options:this.config()},i=this.getData();if(t.clipExtent){var a=new C.Extent(t.clipExtent),r=this._getHeatRadius();r&&(a=a._expand(r));for(var n=[],o=0,s=i.length;o<s;o++)a.contains(new C.Coordinate(i[o][0],i[o][1]))&&n.push(i[o]);e.data=n}else e.data=i;return e},d.fromJSON=function(t){return t&&"HeatLayer"===t.type?new d(t.id,t.data,t.options):null},d.prototype._getHeatRadius=function(){return this._getRenderer()?this._getRenderer()._heatRadius:null},d);function d(t,e,i){r(this,d),Array.isArray(e)||(i=e,e=null);var a=n(this,o.call(this,t,i));return a._heats=e||[],a}function u(){return r(this,u),n(this,a.apply(this,arguments))}c.mergeOptions(h),c.registerJSONType("HeatLayer"),c.registerRenderer("canvas",(i(u,a=C.renderer.CanvasRenderer),u.prototype.draw=function(){var e=this.getMap(),t=this.layer,i=e.getContainerExtent(),a=this.prepareCanvas(),r=i;if(a){if(!(a=a.convertTo(function(t){return e._pointToContainerPoint(t)})).intersects(i))return void this.completeRender();r=i.intersection(a)}this._heater||(this._heater=s(this.canvas)),this._heater.radius(t.options.radius||this._heater.defaultRadius,t.options.blur),t.options.gradient&&this._heater.gradient(t.options.gradient),this._heater.max(t.options.max),this._heatViews||(this._heatViews=[]);var n=t.getData();if(0!==n.length){var o=this._heatData(n,r);this._heater.data(o).draw(t.options.minOpacity),this.completeRender()}else this.completeRender()},u.prototype.drawOnInteracting=function(){this.draw()},u.prototype._heatData=function(t,e){var i=this.getMap(),a=this.layer,r=i.getProjection(),n=[],o=this._heater._r,s=void 0===a.options.max?1:a.options.max,h=o/2,c=[],d=i.offsetPlatform(),u=d.x%h,p=d.y%h,l=void 0,f=void 0,_=void 0,y=void 0,g=void 0,v=void 0;e=e.expand(o).convertTo(function(t){return new C.Point(i._containerPointToPrj(t))}),this._heatRadius=o;for(var w=0,m=t.length;w<m;w++)l=t[w],this._heatViews[w]||(this._heatViews[w]=r.project(new C.Coordinate(l[0],l[1]))),f=this._heatViews[w],e.contains(f)&&(f=i._prjToContainerPoint(f),y=Math.floor((f.x-u)/h)+2,g=Math.floor((f.y-p)/h)+2,v=(void 0!==l[2]?+l[2]:.1)*a.options.heatValueScale,c[g]=c[g]||[],(_=c[g][y])?(_[0]=(_[0]*_[2]+f.x*v)/(_[2]+v),_[1]=(_[1]*_[2]+f.y*v)/(_[2]+v),_[2]+=v):c[g][y]=[f.x,f.y,v]);for(var x=0,b=c.length;x<b;x++)if(c[x])for(var R=0,O=c[x].length;R<O;R++)(_=c[x][R])&&n.push([Math.round(_[0]),Math.round(_[1]),Math.min(_[2],s)]);return n},u.prototype.onZoomEnd=function(){delete this._heatViews,a.prototype.onZoomEnd.apply(this,arguments)},u.prototype.onResize=function(){a.prototype.onResize.apply(this,arguments),this.canvas&&(this._heater._width=this.canvas.width,this._heater._height=this.canvas.height)},u.prototype.onRemove=function(){this.clearHeatCache(),delete this._heater},u.prototype.clearHeatCache=function(){delete this._heatViews},u)),t.HeatLayer=c,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.heatmap v0.6.0, requires maptalks@^0.25.0.")});